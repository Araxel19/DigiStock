{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ocr-process",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "91e6aab7-5caf-4e75-a34a-2007f33d0d49",
      "name": "Webhook OCR",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -1504,
        192
      ],
      "webhookId": "ocr-process"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.body.imageBase64 }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "52c135c1-e9bd-4999-addc-073510cabd9a",
      "name": "Check Base64",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1280,
        192
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\"success\": false, \"message\": \"imageBase64 is required\", \"data\": null}",
        "options": {}
      },
      "id": "5b649cbc-4d64-4568-b6e8-96c64ca0abd2",
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -1072,
        304
      ]
    },
    {
      "parameters": {
        "documentType": "image_url",
        "options": {}
      },
      "type": "n8n-nodes-base.mistralAi",
      "typeVersion": 1,
      "position": [
        -848,
        96
      ],
      "id": "80076f34-d657-4e28-b908-3891a4c6a0d0",
      "name": "Extract text",
      "credentials": {
        "mistralCloudApi": {
          "id": "z0A2VWaN3YoGKbSm",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "body.imageBase64",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -1072,
        96
      ],
      "id": "9f7c11f9-3815-4b96-9f8e-990d98701352",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "jsCode": "// Lee el texto del OCR del nodo anterior\nconst text = $json.pages?.[0]?.markdown;\nif (!text) {\n  throw new Error(\"No se encontró texto en la entrada del OCR.\");\n}\n\n// Obtiene el planillaId que el backend envió al webhook\nconst planillaId = $('Webhook OCR').first().json.body.planillaId;\n\n// Separa las líneas del texto (elimina vacías)\nconst lines = text.split(\"\\n\").filter(l => l.trim() !== \"\");\n\n// Busca la línea del encabezado con las palabras clave de la planilla\nconst headerIndex = lines.findIndex(l =>\n  l.toLowerCase().includes(\"código\") &&\n  l.toLowerCase().includes(\"nombre\") &&\n  l.toLowerCase().includes(\"precio\")\n);\n\n// Si no se encuentra el encabezado, lanza un error descriptivo\nif (headerIndex === -1) {\n  throw new Error(\n    \"No se pudo encontrar la fila de encabezado ('Código', 'Nombre del producto', etc.) en el texto del OCR. Texto extraído:\\n\\n\" + text\n  );\n}\n\n// Extrae los encabezados dividiendo por |\nconst headers = lines[headerIndex]\n  .split(\"|\")\n  .map(h => h.trim().toLowerCase())\n  .filter(h => h);\n\n// Procesa las filas de datos que están después del encabezado\nconst rows = lines.slice(headerIndex + 1).map(line => {\n  const cols = line.split(\"|\").map(c => c.trim()).filter(c => c);\n  if (cols.length < headers.length) return null; // descarta filas incompletas\n\n  let obj = {};\n  headers.forEach((h, i) => {\n    let value = cols[i] || \"\";\n\n    // Limpia valores \"--\"\n    if (value === \"---\") value = \"\";\n\n    // Normaliza valores dentro de $...$ (por ejemplo $-200$ → -200)\n    value = value.replace(/^\\$(.*)\\$$/, \"$1\");\n\n    // Limpia espacios\n    value = value.trim();\n\n    obj[h] = value;\n  });\n\n  return obj;\n}).filter(r => r);\n\n// Filtra filas que no sean datos (por ejemplo SUBTOTAL o TOTAL)\nconst productos = rows.filter(r =>\n  !r[\"código\"]?.toLowerCase().includes(\"subtotal\") &&\n  !r[\"código\"]?.toLowerCase().includes(\"total\") &&\n  !r[\"código\"]?.toLowerCase().includes(\"iva\")\n);\n\n// Devuelve cada producto como un item separado con su planillaId\nreturn productos.map(producto => ({\n  json: {\n    producto,\n    planillaId\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        96
      ],
      "id": "d458ffb1-1789-46f1-8806-3a12d2ed1796",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "// Si no llegan items, no hagas nada.\nif (items.length === 0) {\n  return [];\n}\n\n// 1. Agrupar todos los objetos \"producto\" en un solo array\nconst inventarioCompleto = items.map(item => item.json.producto);\n\n// 2. Tomar el planillaId del PRIMER item que llega (todos tienen el mismo)\nconst planillaId = items[0].json.planillaId;\n\n// 3. Crear el objeto final que el backend espera\nconst payloadFinal = {\n  planillaId: planillaId,\n  inventario: inventarioCompleto\n};\n\n// 4. Devolver el payload final en la estructura correcta\nreturn [{\n  json: payloadFinal\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -416,
        96
      ],
      "id": "5f252dcb-8fe6-4a59-aa85-b68ed998a5a4",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://backend:3000/api/v1/inventory/notify-progress",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "=application/json",
        "body": "={{$json.bodyFinal}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        224
      ],
      "id": "685428a6-d469-4bc4-91c6-a262db25dfa7",
      "name": "Notificar al BackEnd"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://backend:3000/api/v1/ocr/resultados",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        0
      ],
      "id": "68f4c6c7-be29-4768-90e9-d7248e4f61bf",
      "name": "Enviar los Resultados",
      "executeOnce": false,
      "alwaysOutputData": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\n\nconst payload = {\n  planillaId: data.planillaId,\n  status: \"validacion_pendiente\",\n  message: \"OCR completado, listo para validación.\"\n};\n\n// Guarda el TEXTO JSON en una nueva propiedad\n$input.item.json.bodyFinal = JSON.stringify(payload);\n\nreturn $input.item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        208
      ],
      "id": "b76843f5-594b-4173-98a7-c875682a02a0",
      "name": "Code in JavaScript2"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook OCR": {
      "main": [
        [
          {
            "node": "Check Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Base64": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract text": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Extract text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Enviar los Resultados",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Notificar al BackEnd",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c5e83bdf-9441-47be-9e00-9747b8f9c944",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "caf65848650b0f7eb236c4ee42a84e180b9aa80ad723914f1e69469d054c465f"
  },
  "id": "cMf7QaIbcsvBRtSg",
  "tags": []
}