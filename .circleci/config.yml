# CircleCI Configuration for DigiStock
# CI Pipeline con Build, Tests, Docker y SonarCloud

version: 2.1

orbs:
  node: circleci/node@5.0.2

jobs:
  # 游빔 Instalar dependencias y compilar todos los workspaces
  install_and_build_all:
    docker:
      - image: cimg/node:18.16
    working_directory: ~/project
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: "Compilar todos los workspaces"
          command: |
            npm run build:backend
            npm run build:business-logic
      - persist_to_workspace:
          root: ~/project
          paths:
            - backend/dist
            - business-logic/dist

  # 游빍 Ejecutar pruebas (si existen)
  run_tests:
    docker:
      - image: cimg/node:18.16
    working_directory: ~/project
    steps:
      - checkout
      - attach_workspace:
          at: ~/project
      - run:
          name: "Ejecutar pruebas si existen"
          command: |
            if grep -q "\"test\":" package.json; then
              npm test
            else
              echo "No hay pruebas definidas. Saltando paso..."
            fi

  # 游냡 Construir im치genes Docker
  docker_build:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: ./
      - run:
          name: "Construir imagen Docker del backend"
          command: |
            if [ -f backend/Dockerfile ]; then
              docker build -t digistock-backend:ci -f backend/Dockerfile .
            else
              echo "No se encontr칩 backend/Dockerfile. Saltando paso..."
            fi
      - run:
          name: "Construir imagen Docker de business-logic"
          command: |
            if [ -f business-logic/Dockerfile ]; then
              docker build -t digistock-logic:ci -f business-logic/Dockerfile .
            else
              echo "No se encontr칩 business-logic/Dockerfile. Saltando paso..."
            fi

  # 游댌 An치lisis SonarCloud
  sonarcloud_analysis:
    docker:
      - image: cimg/node:18.16
    working_directory: ~/project
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: "Dar permisos y ejecutar SonarCloud"
          command: |
            chmod +x ./node_modules/sonar-scanner/bin/sonar-scanner
            ./node_modules/sonar-scanner/bin/sonar-scanner \
              -Dsonar.organization=DigiStock \
              -Dsonar.projectKey=Araxel19_DigiStock \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.host.url=https://sonarcloud.io

workflows:
  version: 2
  build_pipeline:
    jobs:
      - install_and_build_all
      - run_tests:
          requires:
            - install_and_build_all
      - docker_build:
          requires:
            - install_and_build_all
      - sonarcloud_analysis:
          requires:
            - install_and_build_all
