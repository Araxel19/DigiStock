# CircleCI Configuration for DigiStock
# This config file is used to define the continuous integration pipeline for the project.
# It includes jobs for installing dependencies, running tests, and building artifacts for both frontend and backend.
version: 2.1

# Orbs are reusable packages of CircleCI configuration that you may use in your projects.
orbs:
  node: circleci/node@5.0.2

# The jobs section defines the individual tasks to be executed in the pipeline.
jobs:
  install_and_test_backend:
    docker:
      - image: cimg/node:18.16
    working_directory: ~/project/backend
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          pkg-manager: npm
          app-dir: ~/project/backend
          cache-key: "npm-v1-{{ .Branch }}-{{ checksum \"~/project/backend/package-lock.json\" }}"
      - run:
          name: "Run Backend Tests"
          command: |
            if grep -q "\"test\":" package.json; then
              npm test
            else
              echo "No test command found in backend/package.json. Skipping tests."
            fi
      - run:
          name: "Build Backend"
          command: npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - backend/dist

  install_and_test_frontend:
    docker:
      - image: cimg/node:18.16
    working_directory: ~/project/frontend
    steps:
      - checkout:
          path: ~/project
      - node/install-packages:
          pkg-manager: npm
          app-dir: ~/project/frontend
          cache-key: "npm-v1-{{ .Branch }}-{{ checksum \"~/project/frontend/package-lock.json\" }}"
      - run:
          name: "Run Frontend Tests"
          command: |
            if grep -q "\"test\":" package.json; then
              npm test
            else
              echo "No test command found in frontend/package.json. Skipping tests."
            fi
      - run:
          name: "Build Frontend"
          command: npm run build
      - persist_to_workspace:
          root: ~/project
          paths:
            - frontend/dist
            - frontend/nginx.conf

  build_artifacts:
    docker:
      - image: cimg/node:18.16
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: "List Artifacts"
          command: |
            echo "Listing compiled artifacts..."
            ls -R ~/project

  docker_build:
    docker:
      - image: cimg/base:stable
        auth:
          username: $DOCKER_LOGIN
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: .
      - run:
          name: "Build Backend Docker Image"
          command: |
            echo "Building backend Docker image..."
            docker build -t digistock-backend:ci -f backend/Dockerfile .
      - run:
          name: "Build Frontend Docker Image"
          command: |
            echo "Building frontend Docker image..."
            docker build -t digistock-frontend:ci -f frontend/Dockerfile .

# The workflows section orchestrates the jobs defined above.
workflows:
  version: 2
  build_and_test:
    jobs:
      - install_and_test_backend
      - install_and_test_frontend
      - build_artifacts:
          requires:
            - install_and_test_backend
            - install_and_test_frontend
      - docker_build:
          requires:
            - install_and_test_backend
            - install_and_test_frontend
